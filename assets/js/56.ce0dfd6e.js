(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{555:function(t,a,s){"use strict";s.r(a);var e=s(6),i=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689170945787-4100d80b-506c-4bb2-94be-27ffe295fd90.png#averageHue=%232b2e3f&clientId=u12644e40-3ab0-4&from=paste&height=699&id=u39bfe24b&originHeight=699&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=176716&status=done&style=none&taskId=u0f12d7fa-d159-4fdb-980f-84e31b4b764&title=&width=918",alt:"image.png"}})]),t._v(" "),s("h3",{attrs:{id:"传统的分布式计算存在什么不足"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#传统的分布式计算存在什么不足"}},[t._v("#")]),t._v(" 传统的分布式计算存在什么不足？")]),t._v(" "),s("p",[t._v("其实推荐系统对海量数据并不陌生，我们有Hadoop/Spark这样的大数据工具对付它们。所以很直觉的想法就是，能不能也拿Hadoop/Spark来分布式地训练模型？想想也很简单：")]),t._v(" "),s("ol",[s("li",[t._v("将训练数据分散到所有Slave节点。")]),t._v(" "),s("li",[t._v("Master节点将模型的最新参数广播到所有Slave节点。")]),t._v(" "),s("li",[t._v("每个Slave节点收到最新的参数后，用本地训练数据，先前代再回代，计算出梯度并上传至Master。")]),t._v(" "),s("li",[t._v("Master节点收集齐所有Slave节点发来的梯度后，平均之，再用平均后的梯度更新模型参数。")]),t._v(" "),s("li",[t._v("回到步骤1，开始下一轮训练。")])]),t._v(" "),s("p",[t._v('看上去似乎行得通。但是该方案忽略了推荐系统中数据的第二个特点，"高维稀疏的特征空间"，给以上方案造成了两个困难：')]),t._v(" "),s("ul",[s("li",[t._v("推荐系统的特征动辄上亿、上十亿，每个特征的Embedding：是16位、32位甚至更长，这么大的参数量是一台Master所容纳不下的。")]),t._v(" "),s("li",[t._v("每轮训练中，Master节点都要将这么大的参数量广播到各Slave节点，每个Slave还要将相同大小的梯度回传，占据的带宽、造成的时延都是不敢想像的，绝对达不到在线实时训练的需求。")])]),t._v(" "),s("h3",{attrs:{id:"简述parameter-server-是如何应对推荐系统-高维稀疏-的数据环境的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简述parameter-server-是如何应对推荐系统-高维稀疏-的数据环境的"}},[t._v("#")]),t._v(' 简述Parameter Server：是如何应对推荐系统“高维稀疏"的数据环境的？')]),t._v(" "),s("p",[t._v("为了解决推荐系统中大规模分布式训练的难题，经典论文《Scaling Distributed Machine Learning with the Parameter Server》）提出了Parameter Server架构I6]。简单来说，Parameter Server就是一个分布式的KV数据库，两点设计使它能够克服Master/Slave架构应用于大规模分布式训练时的困难：")]),t._v(" "),s("ul",[s("li",[t._v('模型参数不再集中存储于单一的Master节点，而是由一群PS server节点共同存储、读写，从而突破了单台机器的资源限制，也避免了"单点失效"问题。')]),t._v(" "),s("li",[t._v("得益于推荐系统的特征是超级特征的特点，一个batch的训练数据所包含的非零特征的数目是极其有限的。因此，我们在训练每个batch时，没必要将整个模型的所有参数（i.e，上亿个Embedding）在集群内部传来传去，而只需要传递当前batch所涵盖的有限几个非零特征的参数就可以了，从而能够大大节省带宽与传输时间。")])]),t._v(" "),s("p",[t._v("结构上一个Parameter Server主要由三大类节点组成，如图所示，各类节点的功能如表所示。\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689169089374-05af11a8-88f9-4cbb-93de-90b93712353b.png#averageHue=%23f0efec&clientId=u12644e40-3ab0-4&from=paste&height=978&id=ucb3b381f&originHeight=978&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=279930&status=done&style=none&taskId=u52acf205-b50c-444d-b0ca-ad1a5e03076&title=&width=1080",alt:"image.png"}}),t._v(" "),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689169096929-86e3aa7e-7867-4867-bd04-53629ae992fc.png#averageHue=%23e5e5e5&clientId=u12644e40-3ab0-4&from=paste&height=550&id=u8e6bf378&originHeight=550&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=192232&status=done&style=none&taskId=u5d223615-fbbb-4632-a3ac-3f38814f239&title=&width=1080",alt:"image.png"}}),t._v("\n基于Parameter Server的训练流程如下图所示，每个步骤的具体描述见下表。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689169103332-419d213a-973f-4d58-9c04-e7493a4a0b51.png#averageHue=%23ebe9e9&clientId=u12644e40-3ab0-4&from=paste&height=636&id=u582c6e32&originHeight=636&originWidth=712&originalType=binary&ratio=1&rotation=0&showTitle=false&size=290829&status=done&style=none&taskId=u4f626569-e9f1-4bf4-b5a7-7eb183c21af&title=&width=712",alt:"image.png"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689169142490-39ec1e5f-e19c-4717-b6a8-5072f2e78308.png#averageHue=%23262626&clientId=u12644e40-3ab0-4&from=paste&height=611&id=u3d8506c2&originHeight=611&originWidth=852&originalType=binary&ratio=1&rotation=0&showTitle=false&size=161345&status=done&style=none&taskId=uefbaf50f-a420-4945-ae97-313e55037ef&title=&width=852",alt:"image.png"}})]),t._v(" "),s("p",[t._v("总结下来，Parameter Serveri训练模式是Data Parallelism（数据并行）与Model Parallelism（模型并行）的这两种分布式计算范式的结合体：")]),t._v(" "),s("ul",[s("li",[t._v("Data Parallelism：数据并行很好理解，海量的训练数据分散在各个节点上，每个节点只训练本地的一部分数据，多机并行计算加快了训练速度。")]),t._v(" "),s("li",[t._v("Model Parallelism：推荐系统中的特征动辄上亿，每个Embedding.又包含多个浮点数，这么大的参数量是单机无法承载的，必然分布在一个集群中。接下来，我们也会讲到，由于推荐系统中特征高度稀疏的性质，一轮迭代中，不同Worker节点不太会在同一个特征的参数上产生竞争，因此多个Worker节点相对解耦，天然适合Model Parallelism。")])]),t._v(" "),s("h3",{attrs:{id:"简述ps同步并发-bsp-的步骤-有什么优缺点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简述ps同步并发-bsp-的步骤-有什么优缺点"}},[t._v("#")]),t._v(" 简述PS同步并发（BSP）的步骤，有什么优缺点？")]),t._v(" "),s("p",[t._v("同步并发策略（Bulk Synchronous Parallel，，BSP）下，顺序执行以下四步，如图所示：\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689169723698-357b8d8e-e930-43f4-86f7-0f4e15eee38a.png#averageHue=%23f3efed&clientId=u12644e40-3ab0-4&from=paste&height=262&id=u4d9e5023&originHeight=262&originWidth=752&originalType=binary&ratio=1&rotation=0&showTitle=false&size=186664&status=done&style=none&taskId=u1a128246-998c-45ac-8f7b-491e77788df&title=&width=752",alt:"image.png"}})]),t._v(" "),s("ol",[s("li",[t._v("各Worker完成自己的本轮计算，将梯度汇报给Server，然后阻塞等待。")]),t._v(" "),s("li",[t._v("Server在收集齐所有Worker上报的梯度后，聚合梯度，用SGD算法更新自己负责的那部分模型参数。")]),t._v(" "),s("li",[t._v("Server通知各Worker解除阻塞。")]),t._v(" "),s("li",[t._v("Worker接到解除阻塞的通知，从Server拉取更新过的模型参数，开始下一轮训练。")])]),t._v(" "),s("p",[t._v('这种模式的优点是，多个Worker节点更新Server上的参数时不会发生冲突，所以分布式训练的效果赞同于单机训练的效果。缺点是，一轮迭代中，速度快的节点要停下来等待速度慢的节点，从而形成了"短板效应”，一个慢节点就能拖累整个集群的计算速度。')]),t._v(" "),s("h3",{attrs:{id:"什么是ps异步并发-asp-中的-梯度失效-问题-即使如此-为什么在推荐系统中仍然常用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是ps异步并发-asp-中的-梯度失效-问题-即使如此-为什么在推荐系统中仍然常用"}},[t._v("#")]),t._v(' 什么是PS异步并发（ASP）中的“梯度失效"问题？即使如此，为什么在推荐系统中仍然常用？')]),t._v(" "),s("p",[t._v('在异步并发策略（Asynchronous Parallel，ASP）下，每台Vorker在推送自己的梯度至Server后，不用等待其他Vorker，就可以开始训练下一个patch的数据。由于无须同步，不存在"短板效应"，ASP具有明显的速度优势。\n'),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689169877010-a08e7e0b-3734-4628-9ad7-6afa9700de1d.png#averageHue=%23e7e7e7&clientId=u12644e40-3ab0-4&from=paste&height=176&id=u87ed3fed&originHeight=176&originWidth=812&originalType=binary&ratio=1&rotation=0&showTitle=false&size=147319&status=done&style=none&taskId=uef9cce79-a13d-492d-9e4e-e957fbbe572&title=&width=812",alt:"image.png"}}),t._v('\n但是由于缺乏同步控制，ASP可能发生"梯度失效"（Stale Gradient）的问题，从而影响收敛速度。举一个极\n度简化的例子：')]),t._v(" "),s("ul",[s("li",[t._v("当前Server端上模型参数的版本是"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"0"}})],1)],1)],1)],1)],1),t._v("，有两个Worker节点，都从Server拉取"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"0"}})],1)],1)],1)],1)],1),t._v("，同时开始一轮训练。")],1),t._v(" "),s("li",[t._v("Worker 1的速度比较快，很快训练完本地数据并向Server上报梯度"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"1"}})],1)],1)],1)],1)],1),t._v("。")],1),t._v(" "),s("li",[t._v("Server收到"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"1"}})],1)],1)],1)],1)],1),t._v("后，根据SGD算法迭代一步（步长为"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-mi",{staticClass:"mjx-i"},[s("mjx-c",{attrs:{c:"3BB"}})],1)],1)],1),t._v("），将Server端的参数值由"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"0"}})],1)],1)],1)],1)],1),t._v("更新为"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"1"}})],1)],1)],1),s("mjx-mo",{staticClass:"mjx-n",attrs:{space:"4"}},[s("mjx-c",{attrs:{c:"="}})],1),s("mjx-msub",{attrs:{space:"4"}},[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"0"}})],1)],1)],1),s("mjx-mo",{staticClass:"mjx-n",attrs:{space:"3"}},[s("mjx-c",{attrs:{c:"2212"}})],1),s("mjx-mi",{staticClass:"mjx-i",attrs:{space:"3"}},[s("mjx-c",{attrs:{c:"3BB"}})],1),s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"1"}})],1)],1)],1)],1)],1),t._v("。")],1),t._v(" "),s("li",[t._v("此时Worker 2才完成计算并向Server上报了自己的梯度"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"2"}})],1)],1)],1)],1)],1),t._v("。")],1),t._v(" "),s("li",[t._v("Server收到"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"2"}})],1)],1)],1)],1)],1),t._v("后，如果像"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"2"}})],1)],1)],1),s("mjx-mo",{staticClass:"mjx-n",attrs:{space:"4"}},[s("mjx-c",{attrs:{c:"="}})],1),s("mjx-msub",{attrs:{space:"4"}},[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"1"}})],1)],1)],1),s("mjx-mo",{staticClass:"mjx-n",attrs:{space:"3"}},[s("mjx-c",{attrs:{c:"2212"}})],1),s("mjx-mi",{staticClass:"mjx-i",attrs:{space:"3"}},[s("mjx-c",{attrs:{c:"3BB"}})],1),s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"2"}})],1)],1)],1)],1)],1),t._v("这样更新模型参数，反而可能损害收敛。这是因为"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"2"}})],1)],1)],1)],1)],1),t._v("是Worker 2基于"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"0"}})],1)],1)],1)],1)],1),t._v("计算得到的，而Server端的参数此时已经变成了"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"3B8"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"1"}})],1)],1)],1)],1)],1),t._v(","),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:" MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mn",{staticClass:"mjx-n",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"2"}})],1)],1)],1)],1)],1),t._v("已经失效。")],1)]),t._v(" "),s("p",[t._v('但是在实践中，这个"梯度失效"问题并没有那么严重。得益于推荐系统中的特征超级稀疏的特点，在一轮迭代中，各个Worker节点的局部训练数据所包含的非零特征，相互重叠得并不严重。多个Vorker节点同时更新同一个特征的参数（i.e.，一阶权重或Embedding）的可能性非常小，所以Servert端的冲突也就没有那么频繁和严重，ASP模式在推荐系统中依然比较常用的。\n细心的读者可能会有疑问，在一轮训练中，特征是稀疏的，两个Woker不太可能同时更新同一个特征的参数，使用ASP也较少发生冲突，但是DNN中各层的权重是所有Worker都要更新的吧，使用ASP导致了冲突怎么办？这是一个非常好的问题，也是现代Parameter Server改进的方向之一。')]),t._v(" "),s("h3",{attrs:{id:"什么是半同步半异步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是半同步半异步"}},[t._v("#")]),t._v(" 什么是半同步半异步？")]),t._v(" "),s("p",[t._v('半同步半异步（Staleness Synchronous Parallel，SSP）是BSP与ASP的折衷方案。SSP允许各Worker节点在一定迭代轮数之内保持异步。如果发现最快Worker节点与最慢Worker节点的迭代步数之差已经超过了允许的最大值，所有Worker都要停下来进行一次参数同步，如图所示。SSP希望通过折衷，实现"计算效率"与"收敛精度"之间的平衡。\n'),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/13009966/1689170495963-121a2d22-a548-49ce-9115-bd0c56277ac9.png#averageHue=%23f4f0ee&clientId=u12644e40-3ab0-4&from=paste&height=260&id=u3e658793&originHeight=260&originWidth=950&originalType=binary&ratio=1&rotation=0&showTitle=false&size=219957&status=done&style=none&taskId=uf0758061-c2a0-4a6c-92c2-532fa093698&title=&width=950",alt:"image.png"}})])])}),[],!1,null,null,null);a.default=i.exports}}]);